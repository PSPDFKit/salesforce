<apex:page >
    <!-- PSPDF Init div -->
    <!--<div id="pspdfkit" style="width: 100%; height: 100vh;"></div>-->
    <div id="editor" style="border: 1px solid black; width: 1024px; height: 600px; position: relative"></div>


    <script type="text/javascript"> __sfdcSessionId = '{!$Api.Session_Id}';</script>
    <script src="../../soap/ajax/54.0/connection.js" type="text/javascript"></script>

    <script src="{!$Resource.PSPDFKitDocumentAuthoring}" type="text/javascript"></script>
    <script type="text/javascript">



        console.log("in Document Authoring");
        //console.log(recId);

        window.addEventListener('message', handleDocumentAuthoringMessages);

        function arrayBufferFromUint8Array(uint8Array) {
            return uint8Array.buffer.slice(uint8Array.byteOffset, uint8Array.byteOffset + uint8Array.byteLength);
        }

        async function handleDocumentAuthoringMessages(event) {

            console.log("in handleOpenAndSaveFiles");
            console.log(event);

            const docAuth = await DocAuth.createDocAuthInstance({
                // assets: { base: '<CUSTOM_DOCUMENT_AUTHORING_ASSETS_LOCATION>' }
                // licenseKey: '<YOUR_LICENSE_KEY>',
            });

            
            //let fileArrayBuffer = base64ToArrayBuffer(event.data.fileBase64);
            let fileArrayBuffer;
            if(event.data.fileArrayBuffer){
                const uint8Array = new Uint8Array(event.data.fileArrayBuffer);
                const arrayBuffer = arrayBufferFromUint8Array(uint8Array);
                console.log('ArrayBuffer received:', arrayBuffer);

                const docAuth = await DocAuth.createDocAuthInstance();
                const editor = DocAuth.createEditorInstance({
                    target: document.getElementById("editor"),
                    document: await docAuth.importDocx(Promise.resolve(arrayBuffer)),
                });
            }else{
                const editor = DocAuth.createEditorInstance(
                    {
                        target: document.getElementById("editor"),
                        document: DocAuth.Utils.documentFromPlaintext("Coming soon: Edit your .DOCX files directly in Salesforce!"),
                        //document:  await docAuth.importDocx(Promise.resolve(event.data.fileBase64)),
                        
                    }
                    );
            }


        }            

    </script>
</apex:page>