<apex:page controller="PSPDFKitController">
    <!-- PSPDF Init div -->
    <div id="pspdfkit" style="width: 100%; height: 100vh;"></div>

    <script type="text/javascript"> __sfdcSessionId = '{!$Api.Session_Id}';</script>
    <script src="../../soap/ajax/54.0/connection.js" type="text/javascript"></script>
    <script src="{!$Resource.PSPDFKit20241}" type="text/javascript"></script>
    <script src="{!$Resource.docxtemplater}" type="text/javascript"></script>
    <script src="{!$Resource.inspectModule}" type="text/javascript"></script>
    <script src="{!$Resource.pizzip}" type="text/javascript"></script>
    <script type="text/javascript">


        // Load
        /*********************************/
        let template = "TestTemplate";

        // Get the template from Salesforce
        sforce.connection.query(
            "SELECT VersionData FROM ContentVersion WHERE Title = 'TestTemplate'",
            {
                onSuccess: function (result) {
                    var records = result.getArray("records");
                    // File loaded as Base64
                    var versionData = records[0].VersionData;

                    let binaryString = atob(versionData);

                    let len = binaryString.length;
                    let bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    // File converted into ArrayBuffer
                    let arrayBuffer = bytes.buffer;
                    console.log("File as Array Buffer");
                    console.log(arrayBuffer);
                    loadPSPDFKitCustom(arrayBuffer);

                },
                onFailure: function (error) {
                    console.log("An error has occurred: " + error);
                }
            }
        );

        async function loadPSPDFKitCustom(arrayBufferTemplate) {
            console.log("in loadPSPDFKit");
            let tags = await getPlacholderTags(arrayBufferTemplate);
            console.log("tags found");
            console.log(tags);

            window.parent.postMessage({
                type: 'lwcEvent',
                value: tags
            }, '*');

        }

        async function getPlacholderTags(arrayBufferTemplate) {
            const iModule = window.iModule;
            const zip = new PizZip(arrayBufferTemplate);
            console.log("zip");
            const doc = new docxtemplater(zip, {
                delimiters: { start: "{{", end: "}}" },
                modules: [iModule]
            });
            console.log("doc");
            const tags = iModule.getAllTags();
            return tags;
        }
        /*********************************/

        var recId = '{!fileDetail}';
        var updatedFile;
        var tempInstance = null;
        var contVersion;
        var state;
        var pdf;
        //var baseUrl = `${window.location.protocol}//${window.location.host}{!$Resource.PSPDFKit_lib}/`;
        //var baseCoreUrl = `${window.location.protocol}//${window.location.host}{!$Resource.PSPDFKit_core}/`;
        var baseUrl = "https://pj-document-bucket.s3.ca-central-1.amazonaws.com/pspdfkit-lib-2024-1/";

        const saveButton = {
            type: "custom",
            id: "download-pdf",
            title: "Save",
            onPress: () => {
                saveFileToSalesforce();
            }
        };

        if (recId != null) {
            pdf = '{!conbase}';
            if (pdf != '') {
                var base64str = pdf;
                var binary = atob(base64str.replace(/\s/g, ''));
                var len = binary.length;
                var buffer = new ArrayBuffer(len);
                var view = new Uint8Array(buffer);
                for (var i = 0; i < len; i++) {
                    view[i] = binary.charCodeAt(i);
                }
                pdf = new Blob([view]);
                loadPSPDFKit();
            }
        }

        window.addEventListener('message', handleOpenAndSaveFiles);

        function handleOpenAndSaveFiles(event) {
            console.log("message received on VF page");
            console.log("placeholders received:");
            let placeholders = event.data.placeholders;
            console.log(placeholders);
            state = event.data.state;
            contVersion = event.data;
            pdf = event.data.versionData;
            if (pdf != '') {
                if (tempInstance == null) {
                    loadPSPDFKit();
                } else {
                    PSPDFKit.unload(tempInstance);
                    loadPSPDFKit();
                }
            }
        }

        function loadPSPDFKit() {
            pdf.arrayBuffer().then(val => {

                PSPDFKit.load({
                    inlineWorkers: true,
                    baseUrl,
                    //baseCoreUrl,
                    container: "#pspdfkit",
                    document: val,
                    toolbarItems: PSPDFKit.defaultToolbarItems
                        .filter((item) => item.type !== "signature")
                        .reduce((acc = [], item) => {
                            if (item.type === "ink") {
                                return acc.concat([
                                    item,
                                    { type: "signature", dropdownGroup: "additional-tools" },
                                    { type: "form-creator", dropdownGroup: "additional-tools" },
                                    {
                                        type: "content-editor",
                                        dropdownGroup: "additional-tools",
                                    },
                                    {
                                        type: "redact-text-highlighter",
                                        dropdownGroup: "additional-tools",
                                    },
                                    {
                                        type: "redact-rectangle",
                                        dropdownGroup: "additional-tools",
                                    },
                                ]);
                            }

                            return acc.concat([item]);
                        }, [])
                        .concat([saveButton]),
                    //disableWebAssemblyStreaming: true,
                    //productId: PSPDFKit.ProductId.Salesforce,
                })
                    .then(instance => { tempInstance = instance; })
                    .catch(error => { console.log(error); });
            })
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    let result = reader.result;
                    let base64 = 'base64,';
                    let content = result.indexOf(base64) + base64.length;
                    let fileContents = result.substring(content);
                    resolve(fileContents);
                }
                reader.onerror = error => reject(error);
            });
        }

        function saveFileToSalesforce() {
            tempInstance.exportPDF().then((buffer) => {
                const blob = new Blob([buffer], { type: "application/pdf" });
                getBase64(blob).then((result) => {
                    updatedFile = result;
                    var Object = new sforce.SObject('contentVersion');
                    if (state == 'salesforce') {
                        Object.ContentDocumentId = contVersion.ContentDocumentId;
                        Object.PathOnClient = contVersion.PathOnClient;
                        Object.VersionData = updatedFile;
                        var res = sforce.connection.create([Object]);
                        res[0].success === 'true' ? alert('File updated') : alert('File not updated: ' + res[0].errors.message);
                    } else if (state == 'local') {
                        Object.Title = contVersion.fName;
                        Object.PathOnClient = contVersion.fName;
                        Object.VersionData = updatedFile;
                        Object.contentLocation = 'S';
                        var res = sforce.connection.create([Object]);
                        res[0].success === 'true' ? alert('File Saved Successfully') : alert('File not saved: ' + res[0].errors.message);
                    }
                    else if ('{!contVersion}' != null) {
                        Object.ContentDocumentId = '{!contVersion.ContentDocumentId}';
                        Object.PathOnClient = '{!contVersion.PathOnClient}';
                        Object.VersionData = updatedFile;
                        var res = sforce.connection.create([Object]);
                        res[0].success === 'true' ? alert('File updated') : alert('File not updated: ' + res[0].errors.message);
                    }
                });
            });
        }

        function openSalesforceFile(recordId) {
            if (window.location.href != window.location.origin + "/apex/PSPDFKit_InitPSPDFKit?id=" + recordId) {
                window.open('/apex/PSPDFKit_InitPSPDFKit?id=' + recordId, '_self');
            }
        }
    </script>
</apex:page>